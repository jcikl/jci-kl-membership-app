# 交易用途层级管理功能指南

## 📋 功能概述

交易用途层级管理功能为财务管理系统添加了父目录结构，支持创建根目录和子目录，更好地组织和管理交易用途分类。

## 🎯 主要特性

### 🔧 核心功能
- **层级结构**：支持根目录（level=0）和子目录（level=1）两级结构
- **父目录选择**：创建子目录时可选择父目录
- **树形显示**：表格以树形结构显示交易用途关系
- **层级标识**：通过标签和颜色区分不同层级

### 🛡️ 数据完整性
- **自动层级设置**：根据是否选择父目录自动设置层级
- **父子关系验证**：确保数据关系的一致性
- **状态管理**：支持启用/停用状态管理

## 🚀 使用方法

### 1. 创建根目录
1. 点击"创建新用途"按钮
2. 填写用途名称和分类
3. 不选择父目录（留空）
4. 系统自动设置 `level = 0`
5. 点击确定创建

### 2. 创建子目录
1. 点击"创建新用途"按钮
2. 填写用途名称和分类
3. 在"父目录"字段选择已存在的根目录
4. 系统自动设置 `level = 1`
5. 点击确定创建

### 3. 编辑交易用途
1. 点击表格中的"编辑"按钮
2. 修改用途信息
3. 可以更改父目录选择
4. 系统自动更新层级设置

## 📊 数据结构

### 类型定义更新
```typescript
export interface TransactionPurpose {
  id: string;
  name: string; // 用途名称
  description?: string; // 描述
  category: TransactionPurposeCategory; // 分类
  parentId?: string; // 父目录ID
  level: number; // 层级 (0: 根目录, 1: 子目录)
  isActive: boolean; // 是否启用
  createdBy: string; // 创建者
  createdAt: string;
  updatedAt: string;
}
```

### 层级规则
- **level = 0**：根目录，`parentId` 为 `undefined`
- **level = 1**：子目录，`parentId` 指向根目录的 ID

## 🎨 界面展示

### 表格列结构
```
┌─────────────────────────────────────────────────────────┐
│ 用途名称    │ 层级   │ 父目录    │ 分类   │ 状态   │ 操作 │
├─────────────────────────────────────────────────────────┤
│ 🏷️ 会员费   │ 根目录 │ -         │ 会员费 │ 启用   │ 编辑 │
│ ├ 🏷️ 新会员 │ 子目录 │ 会员费    │ 会员费 │ 启用   │ 编辑 │
│ ├ 🏷️ 续费   │ 子目录 │ 会员费    │ 会员费 │ 启用   │ 编辑 │
│ 🏷️ 活动支出 │ 根目录 │ -         │ 活动   │ 启用   │ 编辑 │
│ ├ 🏷️ 会议费 │ 子目录 │ 活动支出  │ 活动   │ 启用   │ 编辑 │
└─────────────────────────────────────────────────────────┘
```

### 统计信息
```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│ 总用途数: 8 │ 启用用途: 7 │ 根目录: 3   │ 子目录: 5   │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

### 创建/编辑表单
```
┌─────────────────────────────────────────┐
│ 创建交易用途                            │
├─────────────────────────────────────────┤
│ 用途名称: [输入框]                      │
│ 分类: [下拉选择]                        │
│ 父目录: [下拉选择 - 可选]               │
│ 描述: [文本域]                          │
│ 状态: [开关]                           │
├─────────────────────────────────────────┤
│                    [取消] [确定]         │
└─────────────────────────────────────────┘
```

## 🔧 技术实现

### 1. 数据过滤
```typescript
// 获取根目录用途（level = 0）
const rootPurposes = purposes.filter(p => p.level === 0);
// 获取子目录用途（level = 1）
const childPurposes = purposes.filter(p => p.level === 1);
```

### 2. 树形结构构建
```typescript
const buildTreeData = () => {
  const treeData: TransactionPurpose[] = [];
  
  // 添加根目录
  rootPurposes.forEach(root => {
    treeData.push({
      ...root,
      children: purposes.filter(p => p.parentId === root.id)
    });
  });
  
  return treeData;
};
```

### 3. 父目录名称获取
```typescript
const getParentName = (parentId?: string): string => {
  if (!parentId) return '-';
  const parent = purposes.find(p => p.id === parentId);
  return parent?.name || '-';
};
```

### 4. 层级自动设置
```typescript
const purposeData = {
  name: values.name,
  description: values.description || '',
  category: values.category,
  parentId: values.parentId || undefined,
  level: values.parentId ? 1 : 0, // 自动设置层级
  isActive: values.isActive !== undefined ? values.isActive : true,
  createdBy: user?.uid || 'unknown-user',
};
```

## 🎨 功能优势

### 1. 组织性提升
- **层次清晰**：通过父目录结构更好地组织交易用途
- **关系明确**：父子关系一目了然
- **分类细化**：支持更详细的用途分类

### 2. 用户体验
- **直观显示**：树形结构清晰展示层级关系
- **灵活创建**：支持根目录和子目录的灵活创建
- **快速识别**：通过标签和颜色快速识别层级

### 3. 数据管理
- **关系维护**：自动维护父子关系的一致性
- **层级统计**：提供详细的层级统计信息
- **状态同步**：支持层级状态的统一管理

## 🔄 数据迁移

### 现有数据兼容
- 现有交易用途数据会自动设置为根目录（`level = 0`）
- 无需手动迁移，系统自动处理

### 新数据创建
- 新创建的交易用途需要明确指定层级关系
- 建议先创建根目录，再创建子目录

## 📝 使用建议

### 1. 目录规划
- 先规划主要的交易用途类别作为根目录
- 再根据具体需求创建子目录
- 避免过深的层级结构

### 2. 命名规范
- 根目录使用大类名称（如"会员费"、"活动支出"）
- 子目录使用具体名称（如"新会员费"、"会议费"）
- 保持命名的一致性和清晰性

### 3. 状态管理
- 定期检查停用的交易用途
- 确保父子目录状态的一致性
- 及时清理不需要的分类

## 🚨 注意事项

1. **删除限制**：有子目录的根目录不应被删除
2. **层级限制**：目前只支持两级结构（根目录-子目录）
3. **关系维护**：删除父目录前需要先处理子目录
4. **数据一致性**：确保 `parentId` 和 `level` 的一致性

## 🔮 未来扩展

### 可能的改进
- 支持更多层级（三级、四级等）
- 添加拖拽排序功能
- 支持批量层级调整
- 添加层级权限控制
